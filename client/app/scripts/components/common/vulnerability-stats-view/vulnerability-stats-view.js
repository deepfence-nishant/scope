/*eslint-disable*/

// React imports
import React from 'react';
import { connect } from 'react-redux';

// API call methods
import { getAlertStats } from '../../../utils/web-api-utils';
import { fetchRunningContainerCount, fetchRunningHostCount } from '../../../actions/app-actions';

function getResponsiveFontSize(params, defaultSize) {
  let maxNumberDigit;
  if (typeof params === 'object') {
    const maxNumber= Math.max(params.critical, params.high, params.medium, params.low);
    maxNumberDigit = maxNumber.toString().length;
  } else {
    maxNumberDigit = params.toString().length;
  }

  const defaultFontSize= defaultSize;
  const limit = 5;

  let fontSize;
  if (maxNumberDigit <= limit){
    fontSize = `${defaultFontSize}px`;
  } else {
    const extraDigit = maxNumberDigit - limit;
    fontSize = `${(defaultFontSize- (extraDigit*2))}px`;
  }

  return fontSize;
}

class VulnerabilityStatsView extends React.Component {

  constructor(props) {
    super(props);
    this.state = {};
  }

  componentDidMount() {

    // API CALL TO GET CONTAINER AND HOST COUNT FROM SCOPE.
    this.props.dispatch(fetchRunningContainerCount());
    this.props.dispatch(fetchRunningHostCount());

    this.callAlertStatsApi();

    if(this.props.refreshInterval){
      let interval = setInterval(()=>{
        this.callAlertStatsApi();
      }, this.props.refreshInterval.value*1000)
      this.setState({intervalObj : interval});
    }
  }

  componentWillReceiveProps(newProps) {
    if (newProps.days != this.props.days) {
      const queryParams = {
        lucene_query: newProps.searchQuery,
        number: newProps.days.value.number,
        time_unit: newProps.days.value.time_unit,
        _type: 'cve'
      };
      getAlertStats(this.props.dispatch, queryParams);
    }

    if(newProps.refreshInterval && (this.props.refreshInterval != newProps.refreshInterval)){
      let interval = setInterval(()=>{
        this.callAlertStatsApi();
      }, newProps.refreshInterval.value*1000)
      if(this.state.intervalObj){
        clearInterval(this.state.intervalObj);
      }
      this.setState({intervalObj : interval});
    }
    else if((newProps.searchQuery && (this.props.searchQuery != newProps.searchQuery)) || (this.props.days.display != newProps.days.display)){
      this.callAlertStatsApi(
        newProps.searchQuery,
        newProps.days.value.number,
        newProps.days.value.time_unit
      );
    }

  }

  callAlertStatsApi(searchQuery, number, time_unit){
    if (this.props.days) {
      const queryParams = {
        lucene_query: searchQuery || this.props.searchQuery,
        number: number || this.props.days.value.number,
        time_unit: time_unit || this.props.days.value.time_unit,
        _type: 'cve'
      };
      getAlertStats(this.props.dispatch, queryParams);
    }
  }

  componentWillUnmount(){
    if(this.state.intervalObj){
      clearInterval(this.state.intervalObj);
    }
  }

  render() {
    /*const {
      alerts = 0,
      containers = 0,
      hosts = 0,
      criticalAlerts = 0,
      highAlerts = 0,
      mediumAlerts = 0,
      lowAlerts = 0,
    } = this.props;*/

    const {
      total_vulnerabilities = 0,
      critical_vulnerabilities = 0,
      high_vulnerabilities = 0,
      medium_vulnerabilities = 0,
      low_vulnerabilities = 0,
      hosts = 0,
      containers = 0
    } = this.props;

    let params={
      critical: critical_vulnerabilities,
      high: high_vulnerabilities,
      medium: medium_vulnerabilities,
      low: low_vulnerabilities
    }
    const alertsCountFontSize = getResponsiveFontSize(params, 20);
    const totalAlertsCountFontSize = getResponsiveFontSize(params, 36);

    return (
      <div className={`top-vulnerability-stats-wrapper ${this.props.isSideNavCollapsed ? 'collapse-side-nav' : 'expand-side-nav'} ${this.props.isFiltersViewVisible ? 'show-filters-view' : 'hide-filters-view'}`}>
        <div className="total-vulnerability-wrapper">
          <div className="icon-wrapper">
            <div className="icon-total-alerts"></div>
          </div>
          <div className="data-wrapper">
            <div className="total-vulnerability-count" style={{fontSize: totalAlertsCountFontSize}}>{total_vulnerabilities}</div>
            <div className="total-vulnerability-text">total vulnerabilities</div>
          </div>
        </div>
        <div className="vulnerability-wrapper">
          <div className="vulnerability-details critical-alert">
            <div className="vulnerability-details-container">
              <div className="count" style={{fontSize: alertsCountFontSize}}>{critical_vulnerabilities}</div>
              <div className="name">critical</div>
            </div>
          </div>
          <div className="vulnerability-details high-alert">
            <div className="vulnerability-details-container">
              <div className="count" style={{fontSize: alertsCountFontSize}}>{high_vulnerabilities}</div>
              <div className="name">High</div>
            </div>
          </div>
          <div className="vulnerability-details medium-alert">
            <div className="vulnerability-details-container">
              <div className="count" style={{fontSize: alertsCountFontSize}}>{medium_vulnerabilities}</div>
              <div className="name">medium</div>
            </div>
          </div>
          <div className="line-break" />
          <div className="vulnerability-details low-alert">
            <div className="vulnerability-details-container">
              <div className="count" style={{fontSize: alertsCountFontSize}}>{low_vulnerabilities}</div>
              <div className="name">low</div>
            </div>
          </div>
          <div className="vulnerability-details">
            <div className="vulnerability-details-container">
              <div className="count" style={{fontSize: alertsCountFontSize}}>{hosts.hostsCount}</div>
              <div className="name">hosts</div>
            </div>
          </div>
          <div className="vulnerability-details">
            <div className="vulnerability-details-container">
              <div className="count" style={{fontSize: alertsCountFontSize}}>{containers.containerCount}</div>
              <div className="name">containers</div>
            </div>
          </div>
        </div>
      </div>
    );
  }
}

function mapStateToProps(state) {
  return {
    total_vulnerabilities: state.get('total_vulnerabilities'),
    critical_vulnerabilities: state.get('critical_vulnerabilities'),
    high_vulnerabilities: state.get('high_vulnerabilities'),
    medium_vulnerabilities: state.get('medium_vulnerabilities'),
    low_vulnerabilities: state.get('low_vulnerabilities'),
    containers: state.get('containers'),
    hosts: state.get('hosts'),

    isSideNavCollapsed: state.get('isSideNavCollapsed'),
    isFiltersViewVisible: state.get('isFiltersViewVisible'),

    searchQuery: state.get('globalSearchQuery'),
    days: state.get('alertPanelHistoryBound'),
    refreshInterval: state.get('refreshInterval')
  };
}

export default connect(
  mapStateToProps
)(VulnerabilityStatsView);
