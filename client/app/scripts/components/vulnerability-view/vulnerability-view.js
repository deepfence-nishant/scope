/*eslint-disable*/

// React imports
import React from 'react';
import { connect } from 'react-redux';

// Custom component imports
import HeaderView from '../common/header-view/header-view';
import VulnerabilityStatsView from '../common/vulnerability-stats-view/vulnerability-stats-view';
import SideNavigation from '../common/side-navigation/side-navigation';
import NotificationToaster from '../common/notification-toaster/notification-toaster';
import CvBubbleChartView from './cv-bubble-chart-view/cv-bubble-chart-view';
import VulnerabilityTableView from './vulnerability-table-view/vulnerability-table-view';
import LicenseExpiredModalView from '../common/license-expired-modal-view/license-expired-modal-view';

import {
  IS_NOTIFICATION_CHECK_ENABLE,
  NOTIFICATION_POLLING_DURATION
} from '../../constants/visualization-config';
import {
  fetchLicenseStatus,
  pollNotification, setActiveFilters
} from '../../actions/app-actions';

class VulnerabilityView extends React.Component {
  constructor() {
    super();
    this.sideNavMenuCollection = [
      { name: 'topology', menuIcon: 'icon-Topology', isActive: true, link: '/topology' },
      { name: 'alert', menuIcon: 'icon-alert', isActive: false, link: '/alert' },
      { name: 'vulnerabilities', menuIcon: 'icon-biohazard', isActive: false, link: '/vulnerability' },
      { name: 'notification', menuIcon: 'icon-notification', isActive: false, link: '/notification' },
      { name: 'integrations', menuIcon: 'icon-webhook', isActive: false, link: '/integration' },
      { name: 'settings', menuIcon: 'icon-settings', isActive: false, link: '/settings' },
    ];
    this.state = {activeMenu: this.sideNavMenuCollection[0]};
  }

  componentDidMount() {
    this.fetchNotifications();
    this.pollLicenseStatus();

    if(IS_NOTIFICATION_CHECK_ENABLE){
      let interval = setInterval(()=>{
        // Notification polling
        this.fetchNotifications();
        // License polling
        this.pollLicenseStatus();
      }, NOTIFICATION_POLLING_DURATION * 1000);
      this.setState({intervalObj : interval});
    }
  }

  componentWillReceiveProps(newProps){
    if ((newProps.isSuccess && !newProps.isError) && newProps.licenseResponse.license_status == 'expired') {
      this.setState({
        licenseResponse: newProps.licenseResponse,
        isLicenseExpiryModalVisible: true
      });
    } else {
      this.setState({
        isLicenseExpiryModalVisible: false
      });
    }
  }

  componentWillUnmount(){
    if(this.state.intervalObj){
      clearInterval(this.state.intervalObj);
    }
    this.props.dispatch(setActiveFilters(undefined, undefined));
  }

  fetchNotifications() {
    let params = {
      xHostCount: this.props.hosts ? this.props.hosts.hostsCount : 0
    }
    this.props.dispatch(pollNotification(params));
  }

  pollLicenseStatus() {
    this.props.dispatch(fetchLicenseStatus());
  }

  render() {
    const { isLicenseExpiryModalVisible } = this.state;
    const { isToasterVisible } = this.props;

    return (
      <div>

        <SideNavigation navMenuCollection={this.sideNavMenuCollection} activeMenu={this.state.activeMenu} />

        <div className="vulnerability-view-wrapper">
          <HeaderView />

          <VulnerabilityStatsView />

          <CvBubbleChartView />

          <VulnerabilityTableView />
        </div>

        { isLicenseExpiryModalVisible &&  <LicenseExpiredModalView /> }

        { isToasterVisible && <NotificationToaster /> }

      </div>
    );
  }
}

function mapStateToProps(state) {
  return {
    hosts: state.get('hosts'),
    isToasterVisible: state.get('isToasterVisible'),
    isSuccess: state.get('isSuccess'),
    isError: state.get('isError'),
    licenseResponse: state.get('licenseResponse'),
    isSideNavCollapsed: state.get('isSideNavCollapsed'),
    isFiltersViewVisible: state.get('isFiltersViewVisible')
  };
}

export default connect(
  mapStateToProps
)(VulnerabilityView);